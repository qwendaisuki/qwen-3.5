document.addEventListener('DOMContentLoaded',()=>{const menuIcon=document.getElementById('menu-icon'),sidebar=document.getElementById('sidebar'),overlay=document.getElementById('overlay'),closeBtn=document.getElementById('close-btn'),newChatBtn=document.getElementById('new-chat-btn'),chatForm=document.getElementById('chat-form'),chatInput=document.getElementById('chat-input'),chatContainer=document.getElementById('chat-container'),welcomeScreen=document.getElementById('welcome-screen'),chatArea=document.getElementById('chat-area'),attachBtn=document.getElementById('attach-btn'),fileInput=document.getElementById('file-input'),historyContainer=document.getElementById('history-container'),voiceBtn=document.getElementById('voice-btn'),sendBtn=document.getElementById('send-btn'),statusIndicator=document.getElementById('status-indicator');let chatSessions=[],currentChatId=null,attachedFile=null,abortController=new AbortController,isRecognizing=!1;const SpeechRecognition=window.SpeechRecognition||window.webkitSpeechRecognition;let recognition;SpeechRecognition&&(recognition=new SpeechRecognition,recognition.continuous=!1,recognition.lang='id-ID',recognition.interimResults=!1,recognition.onstart=()=>{isRecognizing=!0,voiceBtn.classList.add('listening')},recognition.onresult=e=>{chatInput.value=e.results[0][0].transcript,updateSendButtonState()},recognition.onerror=e=>console.error('Speech recognition error:',e.error),recognition.onend=()=>{isRecognizing=!1,voiceBtn.classList.remove('listening')}),loadSessionsFromStorage(),currentChatId||0>=chatSessions.length||(currentChatId=chatSessions[0].id),renderSidebar(),renderChat(currentChatId),updateSendButtonState(),menuIcon.addEventListener('click',openSidebar),closeBtn.addEventListener('click',closeSidebar),overlay.addEventListener('click',closeSidebar),newChatBtn.addEventListener('click',startNewChat),attachBtn.addEventListener('click',()=>fileInput.click()),fileInput.addEventListener('change',handleFileAttachment),chatForm.addEventListener('submit',handleFormSubmit),voiceBtn.addEventListener('click',toggleVoiceRecognition),sendBtn.addEventListener('click',handleSendOrStop),chatInput.addEventListener('input',updateSendButtonState),document.body.addEventListener('click',handleDynamicClicks);async function handleFormSubmit(e){e.preventDefault();const t=chatInput.value.trim();if(!t&&!attachedFile||sendBtn.classList.contains('loading'))return;'none'!==welcomeScreen.style.display&&(welcomeScreen.style.display='none'),null===currentChatId&&createNewChatSession(t||"Chat baru");const n={role:"user",parts:[{text:t}]};addMessageToSession(currentChatId,n),displayUserMessage(t),chatInput.value='',updateSendButtonState(),await fetchAiResponse()}async function fetchAiResponse(e=!1){const t=getSessionById(currentChatId);if(!t)return;let n,o;if(e){t.messages=t.messages.filter(e=>"user"===e.role),n=t.messages[t.messages.length-1],o=t.messages.slice(0,-1);const r=chatContainer.querySelectorAll('.ai-message');0<r.length&&r[r.length-1].remove()}else n=t.messages[t.messages.length-1],o=t.messages.slice(0,-1);if(!n)return abortController=new AbortController,setLoadingState(!0);try{const r=await fetch('/api/chat',{method:'POST',signal:abortController.signal,headers:{'Content-Type':'application/json'},body:JSON.stringify({prompt:n.parts[0].text||'',history:o})});if(!r.ok)throw new Error((await r.json()).error);const s=r.body.getReader(),a=new TextDecoder;let i="",l=null,c="";for(;;){const{value:e,done:t}=await s.read();if(t)break;c+=a.decode(e,{stream:!0});const n=c.split('\n\n');for(let e=0;e<n.length-1;e++){const t=n[e];if(t.startsWith('data: ')){const r=JSON.parse(t.substring(6));'tool_start'===r.type?updateStatusIndicator('search',r.query):'text_chunk'===r.type&&(l||(updateStatusIndicator('typing'),l=displayAiMessage("",!0)),i+=r.content,l.querySelector('.ai-response-content').innerHTML=marked.parse(i),scrollToBottom())}}c=n[n.length-1]}if(l){const s=extractAndRenderSources(i);l.dataset.rawText=s.cleanText,l.querySelector('.ai-response-content').innerHTML=s.htmlWithSources,l.querySelectorAll('pre code').forEach(e=>{hljs.highlightElement(e)});const a={role:"model",parts:[{text:i}]};e?t.messages[t.messages.length]=a:addMessageToSession(currentChatId,a),saveSessionsToStorage()}}catch(r){'AbortError'!==r.name&&(console.error("Error fetching AI response:",r),displayAiMessage(`Maaf, terjadi kesalahan: ${r.message}`))}finally{setLoadingState(!1),attachedFile=null,fileInput.value=''}}function handleDynamicClicks(e){const t=e.target.closest('.history-item span');t&&(currentChatId=t.parentElement.dataset.id,renderChat(currentChatId),renderSidebar(),closeSidebar());const n=e.target.closest('.menu-dots');if(n){e.stopPropagation();const t=n.nextElementSibling;document.querySelectorAll('.menu-options').forEach(e=>{e!==t&&(e.style.display='none')}),t.style.display='block'===t.style.display?'none':'block'}else document.querySelectorAll('.menu-options').forEach(e=>e.style.display='none');const o=e.target.closest('.delete-btn');o&&deleteSession(o.parentElement.dataset.id);const r=e.target.closest('.export-btn');r&&exportSession(r.parentElement.dataset.id);const s=e.target.closest('.copy-btn');s&&navigator.clipboard.writeText(s.closest('.ai-message').dataset.rawText).then(()=>{const e=s.innerHTML;s.innerHTML='<span>Disalin!</span>',setTimeout(()=>s.innerHTML=e,2e3)});const a=e.target.closest('.like-btn');a&&a.classList.toggle('liked');const i=e.target.closest('.share-btn');i&&navigator.share?navigator.share({title:'Respon dari Qwen',text:i.closest('.ai-message').dataset.rawText}):alert('Fitur bagikan tidak didukung.');const l=e.target.closest('.regen-btn');l&&fetchAiResponse(!0);const c=e.target.closest('.speak-btn');c&&speakText(c.closest('.ai-message').dataset.rawText)}function renderSidebar(){historyContainer.innerHTML='',0<chatSessions.length&&(const e=document.createElement('h3');e.textContent='History',historyContainer.appendChild(e);const t=document.createElement('ul');t.className='history-list',chatSessions.forEach(e=>{const n=document.createElement('li');n.className='history-item',n.dataset.id=e.id,e.id===currentChatId&&n.classList.add('active'),n.innerHTML=`
                    <span>${e.title}</span>
                    <div class="menu-dots" data-id="${e.id}">...</div>
                    <div class="menu-options" data-id="${e.id}">
                        <button class="export-btn">Export</button>
                        <button class="delete-btn">Hapus</button>
                    </div>`,t.appendChild(n)}),historyContainer.appendChild(t))}function renderChat(e){chatContainer.innerHTML='';const t=getSessionById(e);t&&0<t.messages.length?(welcomeScreen.style.display='none',t.messages.forEach(e=>{'user'===e.role?displayUserMessage(e.parts[0].text):'model'===e.role&&displayAiMessage(e.parts[0].text)}),chatContainer.querySelectorAll('pre code').forEach(e=>hljs.highlightElement(e))):welcomeScreen.style.display='flex',scrollToBottom()}function displayUserMessage(e){const t=document.createElement('div');t.className='user-message',t.textContent=e,chatContainer.appendChild(t),scrollToBottom()}function displayAiMessage(e,t=!1){const n=document.createElement('div');n.className='ai-message',t||(n.dataset.rawText=e);const{htmlWithSources:o}=extractAndRenderSources(e);return n.innerHTML=`
            <div class="ai-header"><img src="logo.png" alt="Logo" class="logo-small"><span>Qwen 3.5</span></div>
            <div class="ai-response-content">${o}</div>
            <div class="action-buttons">
                <button class="share-btn" title="Bagikan"><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M4 12v8a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2v-8"></path><polyline points="16 6 12 2 8 6"></polyline><line x1="12" y1="2" x2="12" y2="15"></line></svg><span>Bagikan</span></button>
                <button title="Regenerate" class="regen-btn"><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><polyline points="23 4 23 10 17 10"></polyline><polyline points="1 20 1 14 7 14"></polyline><path d="M3.51 9a9 9 0 0 1 14.85-3.36L23 10M1 14l4.64 4.36A9 9 0 0 0 20.49 15"></path></svg></button>
                <button title="Suka" class="like-btn"><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path data-like-fill="true" d="M7 10v12"></path><path data-like-fill="true" d="M15 5.88 14 10h5.83a2 2 0 0 1 1.92 2.56l-2.33 8A2 2 0 0 1 17.5 22H4a2 2 0 0 1-2-2v-8a2 2 0 0 1 2-2h2.76a2 2 0 0 0 1.79-1.11L12 2h0a3.13 3.13 0 0 1 3 3.88Z"></path></svg></button>
                <button title="Salin" class="copy-btn"><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><rect x="9" y="9" width="13" height="13" rx="2" ry="2"></rect><path d="M5 15H4a2 2 0 0 1-2-2V4a2 2 0 0 1 2-2h9a2 2 0 0 1 2 2v1"></path></svg></button>
                <button title="Dengarkan" class="speak-btn"><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><polygon points="11 5 6 9 2 9 2 15 6 15 11 19 11 5"></polygon><path d="M19.07 4.93a10 10 0 0 1 0 14.14M15.54 8.46a5 5 0 0 1 0 7.07"></path></svg></button>
            </div>`,chatContainer.appendChild(n),scrollToBottom(),n}function updateSendButtonState(){const e=0<chatInput.value.trim().length;voiceBtn.style.display=e?'none':'flex',sendBtn.style.display=e?'flex':'none',sendBtn.querySelector('svg')||setLoadingState(!1)}function setLoadingState(e){sendBtn.innerHTML='',statusIndicator.style.display=e?'flex':'none',e?(sendBtn.classList.add('loading'),updateStatusIndicator('typing'),const t=document.createElementNS("http://www.w3.org/2000/svg","svg");t.setAttribute('class','stop-icon'),t.setAttribute('width','16'),t.setAttribute('height','16'),t.setAttribute('viewBox','0 0 24 24'),t.innerHTML='<rect x="3" y="3" width="18" height="18" fill="white"></rect>',sendBtn.appendChild(t)):(sendBtn.classList.remove('loading'),const t=document.createElementNS("http://www.w3.org/2000/svg","svg");t.setAttribute('class','send-icon'),t.setAttribute('width','20'),t.setAttribute('height','20'),t.setAttribute('viewBox','0 0 24 24'),t.innerHTML='<line x1="12" y1="19" x2="12" y2="5" stroke="currentColor" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round"></line><polyline points="5 12 12 5 19 12" stroke="currentColor" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round"></polyline>',sendBtn.appendChild(t),updateSendButtonState())}function updateStatusIndicator(e,t){let n='';'search'===e?n=`
            <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M12 2v4"/><path d="m4.93 4.93 2.83 2.83"/><path d="M2 12h4"/><path d="m4.93 19.07 2.83-2.83"/><path d="M12 18v4"/><path d="m19.07 19.07-2.83-2.83"/><path d="M22 12h-4"/><path d="m19.07 4.93-2.83 2.83"/></svg>
            <span>Mencari: "${t}"</span>`:'typing'===e&&(n=`
            <span>Qwen sedang mengetik</span>
            <div class="dots"><span></span><span></span><span></span></div>`),statusIndicator.innerHTML=n}function extractAndRenderSources(e){const t=e.match(/Sumber:([\s\S]*)/i);if(!t)return{cleanText:marked.parse(e),htmlWithSources:marked.parse(e)};const n=e.replace(t[0],'').trim(),o=t[1].trim().split('\n').filter(e=>e.trim()).map(e=>{const t=e.match(/\d+\.\s*\[(.*?)\]\((.*?)\)/);return t?`<li><a href="${t[2]}" target="_blank" rel="noopener noreferrer">${t[1]}</a></li>`:''}).join('');return{cleanText:n,htmlWithSources:`${marked.parse(n)}
            <div class="sources-container">
                <h4>Sumber:</h4>
                <ul class="sources-list">${o}</ul>
            </div>`}}function startNewChat(){currentChatId=null,renderChat(null),renderSidebar(),closeSidebar()}function createNewChatSession(e){currentChatId=`chat_${Date.now()}`;const t={id:currentChatId,title:e.substring(0,25)+(25<e.length?'...':''),messages:[]};chatSessions.unshift(t),renderSidebar()}function addMessageToSession(e,t){getSessionById(e)?.messages.push(t)}function deleteSession(e){chatSessions=chatSessions.filter(t=>t.id!==e),saveSessionsToStorage(),currentChatId===e&&startNewChat(),renderSidebar()}function exportSession(e){const t=getSessionById(e);if(!t)return;let n=`Riwayat Chat: ${t.title}\n\n`;t.messages.forEach(e=>{n+=`${'user'===e.role?'Anda':'Qwen'}:\n${e.parts[0].text}\n\n---\n\n`});const o=new Blob([n],{type:'text/plain'}),r=URL.createObjectURL(o),s=document.createElement('a');s.href=r,s.download=`${t.title.replace(/\s+/g,'_')}.txt`,document.body.appendChild(s),s.click(),document.body.removeChild(s),URL.revokeObjectURL(r)}function loadSessionsFromStorage(){chatSessions=JSON.parse(localStorage.getItem('chatSessions'))||[]}function saveSessionsToStorage(){localStorage.setItem('chatSessions',JSON.stringify(chatSessions))}function getSessionById(e){return chatSessions.find(t=>t.id===e)}function handleFileAttachment(e){const t=e.target.files[0];if(!t||5242880<t.size)return void alert("Ukuran file terlalu besar. Maksimal 5MB.");const n=new FileReader;n.onload=e=>{attachedFile={data:e.target.result,mimeType:t.type},chatInput.placeholder=`File "${t.name}" dilampirkan.`},n.readAsDataURL(t)}function scrollToBottom(){chatArea.scrollTop=chatArea.scrollHeight}function openSidebar(){sidebar.classList.add('open'),overlay.classList.add('active')}function closeSidebar(){sidebar.classList.remove('open'),overlay.classList.remove('active')}function toggleVoiceRecognition(){SpeechRecognition?isRecognizing?recognition.stop():recognition.start():alert('Maaf, browser Anda tidak mendukung fitur suara.')}function speakText(e){'speechSynthesis'in window?(window.speechSynthesis.cancel(),const t=new SpeechSynthesisUtterance(e);t.lang='id-ID',window.speechSynthesis.speak(t)):alert('Maaf, browser Anda tidak mendukung fitur Text-to-Speech.')}});